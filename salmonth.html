<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Payment Request + Trip Details (Month from User)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      line-height: 1.6;
    }
    input, textarea {
      padding: 6px;
      margin: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid black;
      text-align: center;
      padding: 6px;
    }
    th {
      background-color: #f0f0f0;
    }
    button {
      padding: 8px 14px;
      margin-top: 10px;
      cursor: pointer;
    }
    #letter, #tripTablePage {
      width: 700px;
      padding: 30px;
      border: 1px solid #ccc;
      background: white;
      text-align: left;
    }
    .right { text-align: right; }
  </style>
</head>
<body>

  <h2>Payment Request & Trip Details Form</h2>

  <!-- USER DETAILS -->
  <div id="userSection">
    <label>Name:</label> <input type="text" id="name"><br>
    <label>Address:</label> <textarea id="address" rows="3" cols="30"></textarea><br>
    <label>V.No:</label> <input type="text" id="vno"><br>
    <label>Ph.No:</label> <input type="text" id="phno"><br>
    <button onclick="saveUser()">Save & Continue</button>
  </div>

  <!-- TRIP INFO -->
  <div id="tripSection" style="display:none;">
    <h3>Trip Details</h3>
    <label>Month (1–12):</label> <input type="number" id="monthNum" min="1" max="12"><br>
    <label>Pickup Place:</label> <input type="text" id="pickup"><br>
    <label>Drop Place:</label> <input type="text" id="drop"><br>
    <label>Amount:</label> <input type="number" id="amount"><br>
    <button onclick="lockDetails()">Save Trip Info</button>
  </div>

  <!-- ADD DATES -->
  <div id="dateSection" style="display:none;">
    <h3>Add Trip Dates</h3>
    <label>Date:</label> <input type="date" id="date"><br>
    <button onclick="addRow()">Add Date</button>
    <button onclick="generatePDF()">Download PDF</button>
  </div>

  <!-- HIDDEN PDF CONTENT -->
  <div id="pdfContainer" style="display:none;">

    <!-- PAGE 1 (Letter) -->
    <div id="page1Wrapper">
      <div id="letter">
        <p id="userDetails"></p>

        <p><strong>To:</strong><br>
          Suguna Pip School,<br>
          Nehru Nagar,<br>
          Coimbatore - 641 014.
        </p>

        <p>Respected Madam,</p>

        <p style="text-indent:40px;">
          My vehicle is operating in your school for <span id="daysCount">0</span> days for the month of 
          <span id="displayMonth"></span> 2025.
          Kindly make the payment in favour of <span id="displayName"></span> — amount Rs. <span id="totalPay">0</span>.
        </p>

        <p style="text-align:center;">Thanking You,</p>

        <p class="right">Yours truly</p>

        <p>Date: ____________</p>
      </div>
    </div>

    <!-- PAGE 2 (Table) -->
    <div id="page2Wrapper">
      <div id="tripTablePage">
        <table id="tripTable">
          <thead>
            <tr>
              <th>NO</th>
              <th>DATE</th>
              <th>PICKUP PLACE</th>
              <th>DROP PLACE</th>
              <th>AMOUNT</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="4" style="text-align:right;">Total Amount</td>
              <td id="totalAmount">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

  </div>

  <script>
    /* ---------- VARIABLES ---------- */
    let count = 0, total = 0;
    let pickupPlace = "", dropPlace = "", fixedAmount = 0, monthName = "";

    /* ---------- HELPERS ---------- */
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function getMonthName(num) {
      const months = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];
      return months[num - 1] || "";
    }

    /* ---------- SAVE USER ---------- */
    function saveUser() {
      const name = document.getElementById("name").value.trim();
      const address = document.getElementById("address").value.trim();
      const vno = document.getElementById("vno").value.trim();
      const phno = document.getElementById("phno").value.trim();

      if (!name || !address || !vno || !phno) {
        alert("Please fill all personal details.");
        return;
      }

      document.getElementById("userSection").style.display = "none";
      document.getElementById("tripSection").style.display = "block";

      const userDetails = `
        <strong>From:</strong><br>
        ${name},<br>
        ${address.replace(/\n/g, "<br>")}<br>
        V.No: ${vno}<br>
        Ph.No: ${phno}
      `;
      document.getElementById("userDetails").innerHTML = userDetails;
      document.getElementById("displayName").innerText = name;
    }

    /* ---------- LOCK TRIP ---------- */
    function lockDetails() {
      const monthNum = parseInt(document.getElementById("monthNum").value);
      pickupPlace = document.getElementById("pickup").value.trim();
      dropPlace = document.getElementById("drop").value.trim();
      fixedAmount = parseFloat(document.getElementById("amount").value);

      if (!monthNum || monthNum < 1 || monthNum > 12) {
        alert("Enter a valid month number (1–12).");
        return;
      }
      if (!pickupPlace || !dropPlace || isNaN(fixedAmount)) {
        alert("Please fill Pickup, Drop, and Amount before proceeding.");
        return;
      }

      monthName = getMonthName(monthNum);
      document.getElementById("displayMonth").innerText = monthName;

      document.getElementById("tripSection").style.display = "none";
      document.getElementById("dateSection").style.display = "block";
      document.getElementById("pdfContainer").style.display = "block";
    }

    /* ---------- ADD DATE ROW ---------- */
    function addRow() {
      const dateValue = document.getElementById("date").value;
      if (!dateValue) {
        alert("Please select a date!");
        return;
      }

      const formattedDate = formatDate(dateValue);
      count++;
      total += fixedAmount;

      const tbody = document.querySelector("#tripTable tbody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${count}</td>
        <td>${formattedDate}</td>
        <td>${pickupPlace}</td>
        <td>${dropPlace}</td>
        <td>${fixedAmount}</td>
      `;
      tbody.appendChild(tr);

      document.getElementById("totalAmount").innerText = total;
      document.getElementById("daysCount").innerText = count;
      document.getElementById("totalPay").innerText = total;

      document.getElementById("date").value = "";
    }

    /* ---------- GENERATE PDF ---------- */
    function generatePDF() {
      const page1 = document.getElementById("page1Wrapper");
      const page2 = document.getElementById("page2Wrapper");
      const container = document.getElementById("pdfContainer");

      container.style.display = "block";

      [page1, page2].forEach(el => {
        el._oldStyle = {
          display: el.style.display || "",
          justifyContent: el.style.justifyContent || "",
          alignItems: el.style.alignItems || "",
          minHeight: el.style.minHeight || "",
          boxSizing: el.style.boxSizing || "",
          pageBreakAfter: el.style.pageBreakAfter || ""
        };
        el.style.display = "flex";
        el.style.justifyContent = "center";
        el.style.alignItems = "center";
        el.style.minHeight = "1122px"; /* A4 height */
        el.style.boxSizing = "border-box";
      });

      page1.style.pageBreakAfter = "always";
      page2.style.pageBreakAfter = "auto";

      const opt = {
        margin: 0,
        filename: 'Payment_Request_and_Trip_Details.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all'] }
      };

      html2pdf().set(opt).from(container).save().then(() => {
        [page1, page2].forEach(el => {
          const s = el._oldStyle;
          el.style.display = s.display;
          el.style.justifyContent = s.justifyContent;
          el.style.alignItems = s.alignItems;
          el.style.minHeight = s.minHeight;
          el.style.boxSizing = s.boxSizing;
          el.style.pageBreakAfter = s.pageBreakAfter;
          delete el._oldStyle;
        });
      });
    }
  </script>

</body>
</html>
